# 0day Murmus CTF streams retracing

- Trying to retrace Murmus CTF 0day vulnerability research streams to probably think about my own methodology

## Radare 

Check out the [playlist](https://www.youtube.com/watch?v=SEGPkc8Pu84)

### What we doing?

- One of the best places to look for memory corruption bugs is where `binary parsing` happens and radare does a lot of binary parsing through a lot of formats, so more chances of bugs cropping up.

### Set up the environment

- Pull the Ubuntu docker image: `sudo docker pull ubuntu`

- Open the environment: `sudo docker run -it ubuntu`

- Make a copy of the clean environment:

	- While in the container, grab the container ID through `docker ps`

	- Commit with `docker commit <containerID> <newImageName>

	- All other work now begins with `docker run -it <newImageName>`

- Building an image backup: `docker save radare2_testing > /home/manwe/Desktop/image.tar`

- Load the image from tar: `docker load < image.tar` and give decent name `docker image tag <oldname>:<oldtag>  <newname>:<newtag>`

### Build the target

- Before building radare2, install `make`, `gcc`

- Clone the repo: `git clone https://github.com/radareorg/radare2.git` and build radare normally. Check if it is working just fine.

- Check if the target is running fine: `rabin2` in this case.

### Build AFLPlusPlus

- `apt-get install -y build-essential python3-dev automake git flex bison libglib2.0-dev libpixman-1-dev python3-setuptools`

- `sudo apt-get install -y lld-11 llvm-11 llvm-11-dev clang-11 || sudo apt-get install -y lld llvm llvm-dev clang `

- `sudo apt-get install -y gcc-$(gcc --version|head -n1|sed 's/.* //'|sed 's/\..*//')-plugin-dev libstdc++-$(gcc --version|head -n1|sed 's/.* //'|sed 's/\..*//')-dev`

- `git clone https://github.com/AFLplusplus/AFLplusplus.git`

- `make distrib`

- `make install`

### Build radare with instrumentation

- Edit `radare2/sys/afl.sh` and update `export CC="afl-clang"` to `export CC="/home/radare2_testing/AFLplusplus/afl-clang-fast"` just in case `afl-clang-fast` is not well built

- Build radare with instrumentation: `./sys/afl.sh`

### Fuzz run 1

- Initialize `i` (inputs) and `o` (outputs)

- A very simple test case `AAAA` as `1` inside `i`

- Run the fuzzer: `afl-fuzz -i i -o o rabin2 - I @@`

	- Issue 1: `Radamsa is now a custom mutator, please use that (custom_mutators/radamsa/).` So go to `AFLPlusPlus/custom_mutators/radamsa` and `make` it. Then set `FL_CUSTOM_MUTATOR_LIBRARY=/home/radare2_testing/AFLplusplus/custom_mutators/radamsa/radamsa-mutator.so`

	- Issue 2: The scaling governors in `/sys/devices/system/cpu/cpu*/cpufreq/scaling_governor` are set to powersave and AFL needs performance. But docker isn't allowing to change these, so we need to let go. So `export AFL_SKIP_CPUFREQ=1`

	- **Every new session needs the environment variables set up**. But they survive across different tmux sessions

And the thing starts!

### Parallelizing things

- `apt-get install tmux` and use tmux panes for clarity

- Every AFL instance uses 1 core. Check CPU cores in `/sys/devices/system/cpu` and see `cpu*`. I have 8. So probably will run 6 cores.

- After running a while, update the inputs: `cp o/default/queue/id\:0000* i/`

- Run instances:

	- **Main instance**: afl-fuzz -i i -o o -M f1 -p exploit rabin2 - I @@  

	- **Rest secondary**:
		
		- `afl-fuzz -i i -o o -S f2 -p coe rabin2 -I @@`

		- `afl-fuzz -i i -o o -S f3 rabin2 -I @@`

		- Open 3-4 more
